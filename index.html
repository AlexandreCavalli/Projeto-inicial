<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Or√ßamento APS</title>
<link rel="stylesheet" href="style.css">
<meta name="viewport" content="width=device-width, initial-scale=1.0">


</head>

<body>
    <button onclick="toggleDarkMode()" id="btnDark">
    üåô Modo escuro
</button>

<div class="input-box">
<strong>C√°lculo Or√ßamento Cortinas</strong><br><br>

<label>Cliente:</label>
<input type="text" id="cliente"><br><br>

<label>Largura (cm):</label>
<input type="number" id="largura"><br><br>

<label>Altura (cm):</label>
<input type="number" id="altura"><br><br>

<label>Modelo da tira:</label>
<select id="tira">
    <option value="12">Perfurada 0,80</option>
    <option value="10">Perfurada 0,60</option>
    <option value="11">Lisa 0,80</option>
    <option value="9">Lisa 0,70</option>
</select><br><br>

<label>Kit guia:</label>
<select id="kitTipo">
    <option value="230">Kit 100</option>
    <option value="280">Kit 130</option>
</select>
<input type="number" id="kitQtd" placeholder="Digite a qtd de guias" ><br><br>

<label>Com pintura ep√≥xi:</label>
<input type="checkbox" id="pintura"><br><br>

<label>Pagamento 3x cart√£o (9%):</label>
<input type="checkbox" id="cartao"><br><br>

<label>Sensor Anti Esmagamento</label>
<input type="number" id="centrais" ><br><br>

<label>M√£o de obra (R$):</label>
<input type="number" id="mao" ><br><br>

<div class="botoes-container">
    <div class="botoes-esquerda">
        <button onclick="calcular()">Calcular</button>
        <button onclick="limpar()">Limpar</button>
    </div>
    <div class="botoes-direita">
        <button onclick="salvarOrcamento()">Salvar</button>
        <button onclick="imprimir()">Enviar Cliente</button>
    </div>
</div>

<div id="msgSalvo" style="display:none;color:green;margin-top:10px;font-weight:bold">
‚úî Or√ßamento salvo no hist√≥rico
</div>
</div>

<div id="resultado" class="resultado-box"></div>

<div id="historicoBox" class="historico-box">
<strong>Hist√≥rico de Or√ßamentos</strong><br><br>
<button onclick="toggleExcluir()">Gerenciar hist√≥rico</button><br><br>
<div id="historico"></div>
</div>

<button class="botao-historico" onclick="toggleHistorico()">üìÑ Hist√≥rico</button>

<script>
let qtd = {}
let ultimoOrcamento = null;
let modoExcluir = false;

function moeda(v) {
    return v.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
}

function calcular() {
    const cliente = document.getElementById("cliente").value;
    const largura = Number(document.getElementById("largura").value);
    const altura = Number(document.getElementById("altura").value);

    if (!cliente || !largura || !altura) {
        alert("Preencha cliente, largura e altura.");
        return;
    }

    const larguraM = largura / 100;
    const area = (largura * altura) / 10000;

    const regras = [
        { ate: 10, motor: 200, preco: 800, eixo: "4,5", soleira: "30 x 50" },
        { ate: 14, motor: 300, preco: 900, eixo: "4,5", soleira: "30 x 50" },
        { ate: 20, motor: 500, preco: 1000, eixo: "5,5", soleira: "40 x 60" },
        { ate: 25, motor: 600, preco: 1150, eixo: "5,5", soleira: "40 x 60" },
        { ate: 30, motor: 800, preco: 2250, eixo: "8.0", soleira: "40 x 80" },
        { ate: 36, motor: 1000, preco: 2750, eixo: "8.0", soleira: "40 x 80" },
        { ate: 49, motor: 1500, preco: 4250, eixo: "8.0", soleira: "40 x 80" },
        { ate: 60, motor: 2000, preco: 5500, eixo: "8.0", soleira: "40 x 80" }
    ];

    const regra = regras.find(r => area <= r.ate);

    const eixoValor = { "4,5": 60, "5,5": 85, "8.0": 163 };
    const soleiraValor = { "30 x 50": 25, "40 x 60": 30, "40 x 80": 35 };

    const valorEixo = larguraM * eixoValor[regra.eixo];
    const valorSoleira = larguraM * soleiraValor[regra.soleira];

    const tiras = Math.ceil(altura / 7.5);
    const valorTiras = tiras * larguraM * Number(document.getElementById("tira").value);

    const valorKit = Number(document.getElementById("kitQtd").value) * Number(document.getElementById("kitTipo").value);
    const pintura = document.getElementById("pintura").checked ? area * 70 : 0;
    const centrais = Number(document.getElementById("centrais").value) * 750;
    const mao = Number(document.getElementById("mao").value);
    const cobreRolo = larguraM * 200;

    const subtotalItens =
        regra.preco + valorEixo + valorSoleira + valorTiras +
        valorKit + pintura + centrais + mao + cobreRolo;

    const nf = subtotalItens * 0.10;
    const subtotal = subtotalItens + nf;
    const taxaCartao = document.getElementById("cartao").checked ? subtotal * 0.09 : 0;
    const total = subtotal + taxaCartao;

    function gerarResumoCliente() {
    const largura = Number(document.getElementById("largura").value);
    const altura = Number(document.getElementById("altura").value);

    const larguraM = (largura / 100).toFixed(2);
    const area = ((largura * altura) / 10000).toFixed(2);

    const tiras = Math.ceil(altura / 7.5);
    const kitGuias = Number(document.getElementById("kitQtd").value) || 0;
    const centrais = Number(document.getElementById("centrais").value) || 0;
    const pintura = document.getElementById("pintura").checked;

    return `
    <table style="width:100%; border-collapse:collapse;">
        <tr><td><b>Motor</b></td><td>1 un.</td></tr>
        <tr><td><b>Eixo</b></td><td>${larguraM} m</td></tr>
        <tr><td><b>Soleira</b></td><td>${larguraM} m</td></tr>
        <tr><td><b>Tiras</b></td><td>${tiras} un.</td></tr>
        <tr><td><b>Kit guia</b></td><td>${kitGuias} un.</td></tr>
        <tr><td><b>Cobre rolo</b></td><td>${larguraM} m</td></tr>

        ${pintura ? `<tr><td><b>Pintura ep√≥xi</b></td><td>${area} m¬≤</td></tr>` : ""}

        ${centrais ? `<tr><td><b>Centrais</b></td><td>${centrais} un.</td></tr>` : ""}
    </table>
    `;
}

    

    document.getElementById("resultado").innerHTML = `
    
<table>

    <tr>
        <td class="desc">
            Motor <span class="qtd">${regra.motor} kg</span>
        </td>
        <td class="valor">${moeda(regra.preco)}</td>
    </tr>

    <tr>
        <td class="desc">
            Eixo <span class="qtd">${regra.eixo}"</span>
        </td>
        <td class="valor">${moeda(valorEixo)}</td>
    </tr>

    <tr>
        <td class="desc">
            Soleira <span class="qtd">${regra.soleira}</span>
        </td>
        <td class="valor">${moeda(valorSoleira)}</td>
    </tr>

    <tr>
    <td class="desc">
        Tiras ${document.getElementById("tira").selectedOptions[0].text}
        <span class="qtd">(${tiras} un.)</span>
    </td>
    <td class="valor">${moeda(valorTiras)}</td>
</tr>

    <tr>
    <td class="desc">
        ${document.getElementById("kitTipo").selectedOptions[0].text}
        <span class="qtd">(${document.getElementById("kitQtd").value || 0} un.)</span>
    </td>
    <td class="valor">${moeda(valorKit)}</td>
</tr>

    <tr>
        <td class="desc">
            Cobre rolo <span class="qtd">${larguraM.toFixed(2)} m</span>
        </td>
        <td class="valor">${moeda(cobreRolo)}</td>
    </tr>

    <tr>
    <td class="desc">
        Pintura ep√≥xi
        
    </td>
    <td class="valor">${moeda(pintura)}</td>
</tr>

    <tr>
    <td class="desc">
        Sensor Anti Esmagamento <span class="qtd">(${document.getElementById("centrais").value || 0} un.)</span>
    </td>
    <td class="valor">${moeda(centrais)}</td>
</tr>

    <tr>
        <td class="desc">M√£o de obra</td>
        <td class="valor">${moeda(mao)}</td>
    </tr>

    <tr class="linha-nf">
        <td class="desc">Nota Fiscal (10%)</td>
        <td class="valor">${moeda(nf)}</td>
    </tr>

    ${document.getElementById("cartao").checked ? `
<tr>
    <td class="desc">Taxa cart√£o (9%)</td>
    <td class="valor">${moeda(taxaCartao)}</td>
</tr>
` : ""}

    <tr class="linha-total">
        <td class="desc">TOTAL</td>
        <td class="valor">${moeda(total)}</td>
    </tr>

</table>`;



    const agora = new Date();
    ultimoOrcamento = {
        cliente,
        data: agora.toLocaleDateString("pt-BR") + " " +
              agora.toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit" }),
        total
    };
}

function salvarOrcamento() {
    if (!ultimoOrcamento) return;
    const lista = JSON.parse(localStorage.getItem("orcamentos") || "[]");
    lista.push(ultimoOrcamento);
    localStorage.setItem("orcamentos", JSON.stringify(lista));
    carregarHistorico();
    document.getElementById("msgSalvo").style.display = "block";
    setTimeout(() => document.getElementById("msgSalvo").style.display = "none", 2000);
}

function carregarHistorico() {
    const lista = JSON.parse(localStorage.getItem("orcamentos") || "[]");
    const h = document.getElementById("historico");
    h.innerHTML = "";
    lista.forEach((o, i) => {
        h.innerHTML += `
        <div class="historico-item">
            ${o.cliente} ‚Äì ${o.data} ‚Äì ${moeda(o.total)}
            <button class="btn-excluir" onclick="excluir(${i})">Excluir</button>
        </div>`;
    });
    atualizarExcluir();
}



function toggleHistorico() {
    const box = document.getElementById("historicoBox");
    box.style.display = box.style.display === "none" ? "block" : "none";
}

function toggleExcluir() {
    modoExcluir = !modoExcluir;
    atualizarExcluir();
}

function atualizarExcluir() {
    document.querySelectorAll(".btn-excluir").forEach(b =>
        b.style.display = modoExcluir ? "inline-block" : "none"
    );
}

function excluir(i) {
    if (!confirm("Excluir or√ßamento?")) return;
    const lista = JSON.parse(localStorage.getItem("orcamentos"));
    lista.splice(i, 1);
    localStorage.setItem("orcamentos", JSON.stringify(lista));
    carregarHistorico();
}

function toggleDarkMode() {
    document.body.classList.toggle('dark');

    const isDark = document.body.classList.contains('dark');
    localStorage.setItem('tema', isDark ? 'dark' : 'light');

    document.getElementById('btnDark').innerText =
        isDark ? '‚òÄÔ∏è Modo claro' : 'üåô Modo escuro';
}

/* Carrega prefer√™ncia salva */
window.onload = () => {
    if (localStorage.getItem('tema') === 'dark') {
        document.body.classList.add('dark');
        document.getElementById('btnDark').innerText = '‚òÄÔ∏è Modo claro';
    }
};

function limpar() {
    document.querySelectorAll("input").forEach(i => {
        if (i.type === "checkbox") i.checked = false;
        else i.value = "";
    });
    document.getElementById("resultado").innerHTML = "";
    ultimoOrcamento = null;
}



carregarHistorico()

function imprimir() {
    const resultado = document.getElementById("resultado");
    const clientee = document.getElementById('cliente').value;
    

    if (!resultado.innerHTML.trim()) {
        alert("Calcule o or√ßamento antes de imprimir.");
        return;
    }

const hoje = new Date();

const dataFormatada = hoje.toLocaleDateString("pt-BR", {
    day: "2-digit",
    month: "long",
    year: "numeric"
});
if (!document.getElementById("pintura").checked) {
    document.querySelectorAll("tr").forEach(tr => {
        if (tr.innerText.toLowerCase().includes("pintura ep√≥xi")) {
            tr.remove();
        }
    });
}


    // guarda o conte√∫do original da p√°gina
    const original = document.body.innerHTML;

    
    

    // troca a p√°gina inteira s√≥ pelo resultado
    document.body.innerHTML = `
        <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="container">
        <div>
            
                        <div id="vermelho" style="color: white; background-color: red;">
                A/C ${clientee}
            </div>
            <u>APS - SolucÃßoÃÉes em Serralheria</u>
            <p>Rua Jos√© Argenta, 127 ‚Äì Caxias do Sul ‚Äì RS </p>
            <p>&#128383; 54 3227 2755 / 99978 7453 </p>
            <a href="">contato@apsserralheria.com.br</a>
            <p>www.apsserralheria.com.br</p>
            <img src="images.jpg" alt="" width="150px">
            <div id="orcamento">Or√ßamento</div>
        <div style="padding:20px;font-family:Arial">
            ${resultado.innerHTML}
        </div>
        <h3>Valor Or√ßado: ${moeda(ultimoOrcamento.total)}</h3>
            <br>
            <p>- Pagamento a vista: Entrada de 50% e restante na entrega</p>
            <p>- Desconto para pagamento a vista de 8% R$</p>
            <p>- Em at√© 12x no cart√£o com juros da m√°quina </p>
            <p>- Or√ßamento valido por 10 dias.</p>

            <br>
          <p>PORTA DE A√áO AUTOM√ÅTICA, em chapa galvanizada, MEIA-CANA, com terminal refor√ßado em tubo, guias laterais chapa dobrada, eixo tubo de a√ßo com pontas de a√ßo maci√ßo,  MOTOR, (monof√°sico) 220 w 1720 RPM com capacidade de carga calculada pra cada medida de porta,freio eletromagn√©tico, fim de curso, limitadores de paradas autom√°ticas, com acionamento atrav√©s de controle remoto e botoeira com tr√™s comandos (abre, para e fecha), sistema de correntes (talha manual) para emerg√™ncia na falta de energia el√©trica. Garantia de 1 ano. <b>Fabrica√ß√£o e pintura ep√≥xi pr√≥pria.</b>
            Instala√ß√£o no local determinado no prazo de 15 dias para cortinas sem pintura e 22 dias para cortinas com pintura.
            <br><br>
            </p>
            <h4>Responsabilidade do cliente:</h4>
            <br>
            <p>- Deixar o local limpo e livre para o dia da instala√ß√£o, caso haja algum objeto que impe√ßa a instala√ß√£o, a mesma ser√° reagendada para os pr√≥ximos 15dias.</p>
            <p>- Deixar um ponto de energia para ligar o motor.</p>
            <p>- Instala√ß√£o ou condu√ß√£o da botoeira, tomada e el√©trica fica por conta do propriet√°rio.</p>
            <p>- Caso o cliente opte por outra forma de esconder o rolo e motor, ser√£o necess√°rios dois acessos de 50x50cm para eventuais manuten√ß√µes.</p>
            <br>

            <h4>ALGUNS DE NOSSOS CLIENTES</h4>
            <img src="imagem-clientes.png" alt="" width="800px">
            <div style="text-align: right;">
            <br>
            <br>

   <div style="text-align: right;">
    <p>Caxias do Sul, ${dataFormatada}.</p>

    <p style="
        font-family: 'Brush Script MT', 'Segoe Script', 'Comic Sans MS', cursive;
        font-size: 18px;
        margin-bottom: 5px;
    ">
        Anderson Pereira Souza
    </p>

    <p>
        -----------------------------------------------------------------<br>
        Anderson Pereira Souza
    </p>
</div>

    `;
// adiciona cabe√ßalho PRODUTOS / QUANTIDADES (somente impress√£o)
// adiciona cabe√ßalho PRODUTOS / QUANTIDADES (somente impress√£o)
const tabela = document.querySelector("table");
if (tabela) {
    const header = document.createElement("tr");
    header.classList.add("cabecalho-print");

    header.innerHTML = `
        <td class="desc">Produtos</td>
        <td class="valor" style="text-align:right;">Quantidades</td>
    `;

    tabela.prepend(header);
}


document.querySelectorAll("table tr").forEach(tr => {
    const tdDesc = tr.querySelector("td.desc");
    const qtdSpan = tr.querySelector(".qtd");
    if (!tdDesc || !qtdSpan) return;

    const texto = tdDesc.innerText.toLowerCase();

    // guarda KG do motor
    if (texto.includes("motor")) {
        const kg = tdDesc.innerText.match(/(\d+\s*kg)/i);
        if (kg) tr.dataset.motorKg = kg[1];
    }

    // guarda modelo do eixo
    if (texto.includes("eixo")) {
        const modelo = tdDesc.innerText.match(/(\d+[.,]?\d*)/);
        if (modelo) tr.dataset.eixoModelo = modelo[1];
    }

    // guarda descri√ß√£o completa da tira
    if (texto.includes("tira")) {
        tr.dataset.tiraTexto = tdDesc.innerText;
    }
});


/* ================================
   PASSO 2 ‚Äî AJUSTAR QUANTIDADES
================================ */
document.querySelectorAll("table tr").forEach(tr => {
    const texto = tr.innerText.toLowerCase();
    const qtdSpan = tr.querySelector(".qtd");
    if (!qtdSpan) return;

    // ITENS FIXOS ‚Üí sempre 1
    if (
    texto.includes("motor") ||
    texto.includes("eixo") ||
    texto.includes("soleira") ||
    (texto.includes("mao") && texto.includes("obra"))
) {
    qtdSpan.textContent = "1";
    qtdSpan.style.display = "inline";
    return;
}

    // ITENS VARI√ÅVEIS ‚Üí s√≥ n√∫mero
   if (
    texto.includes("tira") ||
    texto.includes("kit") ||
    texto.includes("centrais") ||
    texto.includes("sensor anti esmagamento")
) {
    const numero = qtdSpan.innerText.match(/\d+/);
    if (numero) qtdSpan.innerText = numero[0];
}
});


/* ================================
   PASSO 3 ‚Äî RESTAURAR DESCRI√á√ïES
================================ */
document.querySelectorAll("table tr").forEach(tr => {
    const tdDesc = tr.querySelector("td.desc");
    if (!tdDesc) return;

    const texto = tr.innerText.toLowerCase();
let qtdSpan = tr.querySelector(".qtd");

// PINTURA EP√ìXI ‚Üí sempre 1 (cria qtd se n√£o existir)
if (texto.includes("pintura ep√≥xi")) {
    if (!qtdSpan) {
        const tdDesc = tr.querySelector("td.desc");
        if (tdDesc) {
            tdDesc.insertAdjacentHTML(
                "beforeend",
                ' <span class="qtd">1</span>'
            );
        }
    } else {
        qtdSpan.textContent = "1";
    }
    return;
}

// se n√£o tem qtd e n√£o √© pintura ‚Üí ignora
if (!qtdSpan) return;

    // MOTOR ‚Üí volta KG
    if (texto.startsWith("motor") && tr.dataset.motorKg) {
        tdDesc.childNodes[0].nodeValue = `Motor ${tr.dataset.motorKg} `;
    }

    // EIXO ‚Üí volta modelo
    if (texto.startsWith("eixo") && tr.dataset.eixoModelo) {
        tdDesc.childNodes[0].nodeValue = `Eixo ${tr.dataset.eixoModelo}" `;
    }

// TIRA ‚Üí manter descri√ß√£o at√© o modelo (ex: 0,80) e remover o resto
if (texto.startsWith("tira")) {
    const textoOriginal = tdDesc.innerText;

    // mant√©m tudo at√© o √∫ltimo n√∫mero decimal (modelo)
    const match = textoOriginal.match(/^(.*?\d+[.,]\d+)/);

    tdDesc.childNodes[0].nodeValue = match
        ? match[1].trim() + " "
        : textoOriginal.replace(/\(?\s*\d+\s*un\.?\s*\)?/gi, "").trim() + " ";
}
document.querySelectorAll("table tr").forEach(tr => {
    if (tr.innerText.toLowerCase().includes("m√£o de obra")) {
        const td = tr.querySelector("td.desc");
        if (td && !td.querySelector(".qtd")) {
            td.insertAdjacentHTML("beforeend", ' <span class="qtd">1</span>');
        }
    }
});

});


    window.print();

    // volta a p√°gina ao normal
    document.body.innerHTML = original;
}


</script>
<div style="text-align:center; margin-top:20px; font-size:12px; color: gray;">
    Desenvolvido por Alexandre 
</div>
</body>
</html>